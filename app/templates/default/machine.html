{% extends "default/base.html" %}
{% import "default/activity_modal.html" as activity_modal %}

{% block content %}
    {% set ns = namespace(date=None) %}
    <div class="container-fluid">
        <div class="row">
            <div class="col col-auto">
                <form class="form-inline">
                    <div class="form-group">
                        <label for="selectDate">Set Date: </label>
                        <input class="form-control flex-shrink-1" id="selectDate" name="select-date"
                               onchange="changeDate(this)" type="date" value="{{ date }}">
                    </div>
                </form>
            </div>
            <div class="container">
                <div class="row my-2 align-middle">
                    <div class="col col-auto">
                        <h1>
                            {{ machine.name }} - {{ date.strftime("%a %d %b %Y") }}
                        </h1>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col col-8">
                <h2>Jobs </h2>
                <table id="jobTable" class="dataTable table table-striped table-bordered">
                    <thead>
                    <tr>
                        <th scope="col">Job Number</th>
                        <th scope="col">Start</th>
                        <th scope="col">End</th>
                        <th scope="col">Ideal Cycle Time (s)</th>
                        <th scope="col">Good Qty</th>
                        <th scope="col">Reject Qty</th>
                        <th scope="col" class="no-export"></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for job in jobs %}
                        <tr>
                            <td>
                                {{ job.job_number }}
                            </td>
                            <td>
                                {% if job.start_time.date() == date %}
                                    {{ job.start_time.strftime("%H:%M") }}
                                {% else %}
                                    {{ job.start_time.strftime("%H:%M (%d/%m/%Y)") }}
                                {% endif %}
                            </td>
                            <td>
                                {% if job.end_time %}
                                    {% if job.end_time.date() == date %}
                                        {{ job.end_time.strftime("%H:%M") }}
                                    {% else %}
                                        {{ job.end_time.strftime("%H:%M (%d/%m/%Y)") }}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {{ job.ideal_cycle_time_s }}
                            </td>
                            <td>
                                {{ good_production_dict[job.id] }}
                            </td>
                            <td>
                                {{ reject_production_dict[job.id] }}
                            </td>
                            <td>
                                <button type="button" class="btn btn-dark">
                                    Edit
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col col-4">
                <h2>Activities</h2>

                <table id="activityTable" class="dataTable table table-striped">
                    <thead>
                    <tr>
                        <th scope="col">Time</th>
                        <th scope="col">State</th>
                        <th scope="col" class="no-export"></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for act in activities %}
                        <tr>
                            <td>
                                {% if act.start_time.date() == date %}
                                    {{ act.start_time.strftime("%H:%M") }}
                                {% else %}
                                    {{ act.start_time.strftime("%H:%M (%d/%m/%Y)") }}
                                {% endif %}
                                ->
                                {% if act.end_time %}
                                    {% if act.end_time.date() == date %}
                                        {{ act.end_time.strftime("%H:%M") }}
                                    {% else %}
                                        {{ act.end_time.strftime("%H:%M (%d/%m/%Y)") }}
                                    {% endif %}
                                {% else %}
                                    now
                                {% endif %}
                            </td>
                            <td>
                                {{ act.activity_code.short_description }}
                            </td>
                            <td>
                                <div class="col col-2 text-right">
                                    <button type="button" class="btn btn-dark" data-toggle="modal"
                                            data-target="#editActivityModal{{ act.id }}">
                                        Edit
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{ activity_modal.edit_activity_modal(act, activity_form) }}
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
{#    Reload the page for a different date when the date select box changes #}
        function changeDate(selectDate) {
            window.location.replace("{{ url_for("default.machine_report", machine_id=machine.id)}}" + "&date=" + selectDate.value)
        }
    </script>
    <script>

        function putActivity(activityId, newActivityCodeId, dropdownIndex) {
            let data = {
                activity_code_id: newActivityCodeId
            }
            $.ajax({
                url: '/api/activity/' + activityId,
                type: 'PUT',
                data: JSON.stringify(data),
                contentType: "application/json",
                success: function (result) {
                    window.location.reload();
                }
            });
        }
    </script>




    {# Datatables core libraries #}
    <script src="{{ url_for('static', filename='node_modules/datatables.net/js/jquery.dataTables.min.js') }}"
            type="text/javascript"></script>
    <script src="{{ url_for('static', filename='node_modules/datatables.net-bs4/js/dataTables.bootstrap4.min.js') }}"
            type="text/javascript"></script>
    <link href="{{ url_for('static', filename='node_modules/datatables.net-bs4/css/dataTables.bootstrap4.min.css') }}"
          type="text/css" rel="stylesheet">

    {# To make the table size responsive for mobile #}
    <script src="{{ url_for('static', filename='node_modules/datatables.net-responsive/js/dataTables.responsive.min.js') }}"
            type="text/javascript"></script>
    <script src="{{ url_for('static', filename='node_modules/datatables.net-responsive-bs4/js/responsive.bootstrap4.min.js') }}"
            type="text/javascript"></script>
    <link href="{{ url_for('static', filename='node_modules/datatables.net-responsive-bs4/css/responsive.bootstrap4.min.css') }}"
          type="text/css" rel="stylesheet">

    {#  Buttons to download the table #}
    <script src="{{ url_for('static', filename='node_modules/datatables.net-buttons/js/dataTables.buttons.min.js') }}"
            type="text/javascript"></script>
    <script src="{{ url_for('static', filename='node_modules/datatables.net-buttons-bs4/js/buttons.bootstrap4.min.js') }}"
            type="text/javascript"></script>
    <script src="{{ url_for('static', filename='node_modules/datatables.net-buttons/js/buttons.html5.min.js') }}"
            type="text/javascript"></script>
    <link href="{{ url_for('static', filename='node_modules/datatables.net-buttons-bs4/css/buttons.bootstrap4.min.css') }}"
          type="text/css" rel="stylesheet">

    {# Table download format options #}
    <script src="{{ url_for('static', filename='node_modules/pdfmake/build/pdfmake.min.js') }}"
            type="text/javascript"></script>
    <script src="{{ url_for('static', filename='node_modules/pdfmake/build/vfs_fonts.js') }}"
            type="text/javascript"></script>
    <script src="{{ url_for('static', filename='node_modules/jszip/dist/jszip.min.js') }}"></script>


    <script>
        {# Script to add the datatable library to the table. #}
        let dataTablesButtons = [
            {
                extend: 'copy',
                text: 'Copy',
                className: 'btn btn-default',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'excel',
                text: 'Excel',
                className: 'btn btn-default',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'csv',
                text: 'CSV',
                className: 'btn btn-default',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            },
            {
                extend: 'pdf',
                text: 'PDF',
                className: 'btn btn-default',
                exportOptions: {
                    columns: ':not(.no-export)'
                }
            }
        ]
        $(document).ready(function () {
                $('#jobTable').DataTable({
                    dom: 'Bfrtip',
                    responsive: true,
                    scrollY: '400px',
                    paging: false,
                    sorting: false,
                    searching: false,
                    buttons: dataTablesButtons
                });
                $('#activityTable').DataTable({
                    dom: 'Bfrtip',
                    responsive: true,
                    scrollY: '400px',
                    paging: false,
                    sorting: false,
                    searching: false,
                    buttons: dataTablesButtons
                });
            }
        );
    </script>


    {#    Set the page title. This will also set the title of any downloaded file #}
    <script>
        $(document).ready(function () {
            document.title = "{{ machine.name }} report - {{ date }}"
        })
    </script>

{% endblock %}

